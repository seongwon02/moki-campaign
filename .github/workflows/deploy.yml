name: MOKI-CAMPAIGN CI/CD

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'backend/**'

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ github.sha }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        working-directory: ./backend
        run: chmod +x gradlew

      - name: Build with Gradle (includes test)
        working-directory: ./backend
        run: ./gradlew build

      - name: Build Docker image
        working-directory: ./backend
        run: |
          docker build -t knu-connect-be:${{ github.sha }} .
          docker save knu-connect-be:${{ github.sha }} > ../app.tar

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: app
          path: app.tar

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: app

      - name: Deploy to EC2
        env:
          PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
          HOST: ${{ secrets.EC2_HOST }}
          USER: ${{ secrets.EC2_USERNAME }}
          IMAGE_TAG: ${{ needs.build.outputs.image_tag }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          # ğŸ‘‡ [ì¶”ê°€] JWT ê´€ë ¨ í™˜ê²½ë³€ìˆ˜ë¥¼ GitHub Secretsì—ì„œ ê°€ì ¸ì˜µë‹ˆë‹¤.
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          JWT_ACCESS_EXP_SECONDS: ${{ secrets.JWT_ACCESS_EXP_SECONDS }}
        run: |
          echo "$PRIVATE_KEY" > private_key.pem
          chmod 600 private_key.pem

          # Docker ì´ë¯¸ì§€ ì „ì†¡
          scp -i private_key.pem -o StrictHostKeyChecking=no app.tar ${USER}@${HOST}:/home/${USER}/

          # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          ssh -i private_key.pem -o StrictHostKeyChecking=no ${USER}@${HOST} "
            set -e

            echo '=== Docker ì´ë¯¸ì§€ ë¡œë“œ ì‹œì‘ ==='
            docker load < /home/${USER}/app.tar
            echo 'âœ… Docker ì´ë¯¸ì§€ ë¡œë“œ ì™„ë£Œ'

            echo '=== ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬ ==='
            docker stop knu-connect-be 2>/dev/null || echo 'ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì—†ìŒ'
            docker rm knu-connect-be 2>/dev/null || echo 'ì‚­ì œí•  ì»¨í…Œì´ë„ˆ ì—†ìŒ'

            echo '=== ìƒˆë¡œìš´ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ==='
            docker run -d \
              --name knu-connect-be \
              --restart unless-stopped \
              -p 8080:8080 \
              -e DB_HOST=${DB_HOST} \
              -e DB_PORT=${DB_PORT} \
              -e DB_NAME=${DB_NAME} \
              -e DB_USERNAME=${DB_USERNAME} \
              -e DB_PASSWORD=${DB_PASSWORD} \
              # ğŸ‘‡ [ì¶”ê°€] Docker ì»¨í…Œì´ë„ˆì— JWT í™˜ê²½ë³€ìˆ˜ë¥¼ ì „ë‹¬í•©ë‹ˆë‹¤.
              -e JWT_SECRET=${JWT_SECRET} \
              -e JWT_ACCESS_EXP_SECONDS=${JWT_ACCESS_EXP_SECONDS} \
              knu-connect-be:${IMAGE_TAG}
            
            echo 'âœ… ì»¨í…Œì´ë„ˆ ì‹œì‘ë¨ (ID: $(docker ps -q -f name=knu-connect-be))'

            echo '=== ì»¨í…Œì´ë„ˆ ë¡œê·¸ (ìµœê·¼ 20ì¤„) ==='
            sleep 5
            docker logs knu-connect-be --tail 20

            echo '=== í—¬ìŠ¤ì²´í¬ ì‹œì‘ (ìµœëŒ€ 60ì´ˆ ëŒ€ê¸°) ==='
            for i in {1..30}; do
              if ! docker ps | grep -q knu-connect-be; then
                echo 'âŒ ì»¨í…Œì´ë„ˆê°€ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤!'
                docker logs knu-connect-be --tail 100
                exit 1
              fi
              
              if curl -f http://localhost:8080/actuator/health > /dev/null 2>&1; then
                echo 'âœ… í—¬ìŠ¤ì²´í¬ ì„±ê³µ! ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì •ìƒ ì‘ë™ ì¤‘ì…ë‹ˆë‹¤.'
                
                rm /home/${USER}/app.tar
                docker image prune -f > /dev/null 2>&1
                
                echo '=== ë°°í¬ ì™„ë£Œ ==='
                docker ps | grep knu-connect-be
                exit 0
              fi
              
              echo 'â³ Attempt $i/30: ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì¤‘...'
              sleep 2
            done

            echo 'âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ - ì• í”Œë¦¬ì¼€ì´ì…˜ì´ 60ì´ˆ ë‚´ì— ì‹œì‘í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.'
            echo '=== ì „ì²´ ë¡œê·¸ ì¶œë ¥ ==='
            docker logs knu-connect-be
            exit 1
          "
          rm private_key.pem
