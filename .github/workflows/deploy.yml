name: MOKI-CAMPAIGN CI/CD (BE & AI)

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
      - 'ai/**'         
  pull_request:
    branches: [ main ]
    paths:
      - 'backend/**'
      - 'ai/**'
      
  workflow_dispatch:

jobs:
  build-all:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ github.sha }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # --- 1. Back-end 빌드 ---
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        working-directory: ./backend
        run: chmod +x gradlew

      - name: Build Backend with Gradle
        working-directory: ./backend
        run: ./gradlew build

      - name: Build Backend Docker image
        working-directory: ./backend
        run: |
          docker build -t moki-be:${{ github.sha }} .          # <--- [이름 변경]
          docker save moki-be:${{ github.sha }} > ../app.tar    # <--- [이름 변경]

      - name: Upload Backend artifact
        uses: actions/upload-artifact@v4
        with:
          name: app # 백엔드 아티팩트
          path: app.tar

      # --- 2. AI 빌드 ---
      - name: Build AI Docker image
        working-directory: ./ai # AI 폴더 기준으로 실행
        run: |
          docker build -t moki-ai-server:${{ github.sha }} -f server/AI/Dockerfile .
          docker save moki-ai-server:${{ github.sha }} > ../ai.tar
          
      - name: Upload AI artifact
        uses: actions/upload-artifact@v4
        with:
          name: ai-app # AI 아티팩트
          path: ai.tar

  deploy-all:
    needs: build-all
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Download Backend artifact
        uses: actions/download-artifact@v4
        with:
          name: app
          
      - name: Download AI artifact
        uses: actions/download-artifact@v4
        with:
          name: ai-app

      - name: Deploy to EC2
        env:
          PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
          HOST: ${{ secrets.EC2_HOST }}
          USER: ${{ secrets.EC2_USERNAME }}
          IMAGE_TAG: ${{ needs.build-all.outputs.image_tag }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          JWT_ACCESS_EXP_SECONDS: ${{ secrets.JWT_ACCESS_EXP_SECONDS }}
          AI_SERVICE_URL: ${{ secrets.AI_SERVICE_URL }}
        run: |
          echo "$PRIVATE_KEY" > private_key.pem
          chmod 600 private_key.pem

          echo '=== Docker 이미지 2개 전송 ==='
          scp -i private_key.pem -o StrictHostKeyChecking=no app.tar ${USER}@${HOST}:/home/${USER}/
          scp -i private_key.pem -o StrictHostKeyChecking=no ai.tar ${USER}@${HOST}:/home/${USER}/
          echo '✅ 이미지 전송 완료'

          ssh -i private_key.pem -o StrictHostKeyChecking=no ${USER}@${HOST} "
            set -e

            echo '=== 1. 백엔드 이미지 로드 ==='
            docker load < /home/${USER}/app.tar
            echo '=== 2. AI 이미지 로드 ==='
            docker load < /home/${USER}/ai.tar

            echo '=== 3. 기존 컨테이너 정리 ==='
            docker stop moki-be 2>/dev/null || echo '기존 백엔드 컨테이너 없음'  
            docker rm moki-be 2>/dev/null || echo '삭제할 백엔드 컨테이너 없음'
            
            docker stop moki-ai 2>/dev/null || echo '기존 AI 컨테이너 없음'
            docker rm moki-ai 2>/dev/null || echo '삭제할 AI 컨테이너 없음'

            docker network create moki-net 2>/dev/null || echo 'moki-net 네트워크 이미 존재함'

            echo '=== 4. 새로운 AI 컨테이너 실행 ==='
            docker run -d \
              --name moki-ai \
              --network moki-net \
              --restart unless-stopped \
              -p 8000:8000 \
              moki-ai-server:${IMAGE_TAG}
            echo '✅ AI 컨테이너 시작됨 (ID: $(docker ps -q -f name=moki-ai))'

            echo '=== 5. 새로운 백엔드 컨테이너 실행 ==='
            docker run -d \
              --name moki-be \
              --network moki-net \
              --restart unless-stopped \
              -p 8080:8080 \
              -e DB_HOST=${DB_HOST} \
              -e DB_PORT=${DB_PORT} \
              -e DB_NAME=${DB_NAME} \
              -e DB_USERNAME=${DB_USERNAME} \
              -e DB_PASSWORD=${DB_PASSWORD} \
              -e JWT_SECRET=${JWT_SECRET} \
              -e JWT_ACCESS_EXP_SECONDS=${JWT_ACCESS_EXP_SECONDS} \
              -e AI_SERVICE_URL=${AI_SERVICE_URL} \
              moki-be:${IMAGE_TAG}
            
            echo '✅ 백엔드 컨테이너 시작됨 (ID: $(docker ps -q -f name=moki-be))'
            
            echo '=== 6. AI 헬스체크 (최대 30초 대기) ==='
            for i in {1..15}; do
              if curl -f http://localhost:8000/ > /dev/null 2>&1; then
                echo '✅ AI 헬스체크 성공!'
                break
              fi
              echo '⏳ AI 시작 대기 중... ($i/15)'
              sleep 2
            done

            echo '=== 7. 백엔드 헬스체크 (최대 60초 대기) ==='
            for i in {1..30}; do
              if ! docker ps | grep -q moki-be; then
                echo '❌ 백엔드 컨테이너가 중지되었습니다!'
                docker logs moki-be --tail 100
                exit 1
              fi
              
              if curl -f http://localhost:8080/actuator/health > /dev/null 2>&1; then
                echo '✅ 백엔드 헬스체크 성공!'
                
                rm /home/${USER}/app.tar
                rm /home/${USER}/ai.tar
                docker image prune -f > /dev/null 2>&1
                
                echo '=== 배포 완료 ==='
                docker ps
                exit 0
              fi
              
              echo '⏳ 백엔드 시작 대기 중... ($i/30)'
              sleep 2
            done

            echo '❌ 헬스체크 실패 - 60초 내에 시작하지 못했습니다.'
            echo '=== 백엔드 로그 ==='
            docker logs moki-be
            echo '=== AI 로그 ==='
            docker logs moki-ai
            exit 1
          "
          rm private_key.pem
